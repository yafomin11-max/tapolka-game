const TelegramBot = require('node-telegram-bot-api');
const express = require('express');
const mongoose = require('mongoose');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
const TELEGRAM_TOKEN = 'YOUR_BOT_TOKEN';
const MONGODB_URI = 'mongodb://localhost:27017/mops_tapolka';
const PORT = process.env.PORT || 3000;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
const bot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });
const app = express();

app.use(express.json());
app.use(express.static('public'));

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
mongoose.connect(MONGODB_URI)
  .then(() => console.log('‚úÖ Connected to MongoDB'))
  .catch(err => console.log('‚ùå MongoDB connection error:', err));

// –ú–æ–¥–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
const userSchema = new mongoose.Schema({
  userId: { type: Number, required: true, unique: true },
  username: String,
  firstName: String,
  lastName: String,
  
  // –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞
  mopsCoins: { type: Number, default: 100 },
  totalTaps: { type: Number, default: 0 },
  miningRate: { type: Number, default: 0 },
  lastMiningTime: { type: Date, default: Date.now },
  
  // –ö–∞—Ä—Ç–æ—á–∫–∏ –º–æ–ø—Å–æ–≤
  ownedCards: [{
    id: Number,
    name: String,
    emoji: String,
    rarity: String,
    mining: Number,
    price: Number,
    purchasedAt: { type: Date, default: Date.now }
  }],
  
  // –ú–∞–≥–∞–∑–∏–Ω
  shopItems: [{
    id: Number,
    name: String,
    emoji: String,
    rarity: String,
    price: Number,
    mining: Number
  }],
  shopRefreshTime: { type: Date, default: Date.now },
  
  // –ü—Ä–æ–º–æ–∫–æ–¥—ã
  usedPromoCodes: [String],
  
  // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
  referralCode: String,
  referredUsers: [Number],
  referralBonusActive: { type: Boolean, default: false },
  referralBonusEndTime: Date,
  tapMultiplier: { type: Number, default: 1 },
  
  // –î–æ–Ω–∞—Ç —Å–∏—Å—Ç–µ–º–∞
  premiumCoins: { type: Number, default: 0 },
  gameTokens: { type: Number, default: 0 },
  exchangeRate: { type: Number, default: 0.1 },
  
  // –ê–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç—ã
  activeBoosts: [{
    id: String,
    name: String,
    effect: String,
    value: Number,
    expiresAt: Date
  }],
  
  // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
  inventory: [{
    id: String,
    name: String,
    type: String,
    effect: String,
    value: mongoose.Schema.Types.Mixed,
    purchasedAt: { type: Date, default: Date.now },
    expiresAt: Date
  }],
  
  // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  transactions: [{
    type: String,
    amount: Number,
    currency: String,
    itemId: String,
    packageId: String,
    date: { type: Date, default: Date.now }
  }],
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  level: { type: String, default: "ü•â –ù–æ–≤–∏—á–æ–∫" },
  joinedAt: { type: Date, default: Date.now }
});

const User = mongoose.model('User', userSchema);

// –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
const CARD_TYPES = [
  {
    id: 1,
    name: "–ú–æ–ø—Å —à–∞—Ö—Ç–µ—Ä",
    emoji: "‚õèÔ∏èüêï",
    rarity: "common",
    price: 10,
    mining: 0.01,
    shopChance: 15
  },
  {
    id: 2, 
    name: "–í–∑—Ä–æ—Å–ª—ã–π –º–æ–ø—Å",
    emoji: "üêï",
    rarity: "common", 
    price: 50,
    mining: 0.1,
    shopChance: 10
  },
  {
    id: 3,
    name: "–ú–æ–ø—Å –≤ –æ—á–∫–∞—Ö", 
    emoji: "ü§ìüêï",
    rarity: "rare",
    price: 200,
    mining: 0.5,
    shopChance: 5
  },
  {
    id: 4,
    name: "–ó–æ–ª–æ—Ç–æ–π –º–æ–ø—Å",
    emoji: "‚≠êüêï", 
    rarity: "epic",
    price: 1500,
    mining: 5,
    shopChance: 3
  },
  {
    id: 5,
    name: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –º–æ–ø—Å",
    emoji: "üí´üêï",
    rarity: "legendary", 
    price: 10000,
    mining: 50,
    shopChance: 2
  }
];

const PROMO_CODES = {
  mops: { coins: 5000, used: false },
  mandarin: { coins: 5000, used: false },
  kolbasa: { coins: 5000, used: false }
};

const DONATE_SHOP = [
  {
    id: "boost_1h",
    name: "‚ö° –ë—É—Å—Ç –Ω–∞ 1 —á–∞—Å",
    description: "–£–¥–≤–∞–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ –æ—Ç —Ç–∞–ø–æ–≤",
    price_premium: 10,
    price_tokens: 1,
    effect: "tap_multiplier",
    value: 2,
    duration: 3600,
    type: "boost"
  },
  {
    id: "mining_boost", 
    name: "üè≠ –ë—É—Å—Ç –º–∞–π–Ω–∏–Ω–≥–∞",
    description: "+50% –∫ –º–∞–π–Ω–∏–Ω–≥—É –Ω–∞ 2 —á–∞—Å–∞",
    price_premium: 15,
    price_tokens: 1.5,
    effect: "mining_multiplier", 
    value: 1.5,
    duration: 7200,
    type: "boost"
  },
  {
    id: "skin_gold",
    name: "üé® –ó–æ–ª–æ—Ç–æ–π –º–æ–ø—Å",
    description: "–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π —Å–∫–∏–Ω",
    price_premium: 50,
    price_tokens: 5,
    effect: "skin",
    value: "golden",
    permanent: true,
    type: "cosmetic"
  },
  {
    id: "energy_100",
    name: "üîã –≠–Ω–µ—Ä–≥–∏—è +100",
    description: "–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏", 
    price_premium: 5,
    price_tokens: 0.5,
    effect: "energy",
    value: 100,
    type: "consumable"
  }
];

const DONATE_PACKAGES = [
  {
    id: "starter",
    name: "–°—Ç–∞—Ä—Ç–µ—Ä",
    premium_coins: 100,
    bonus: 10,
    price_rub: 99
  },
  {
    id: "premium",
    name: "–ü—Ä–µ–º–∏—É–º",
    premium_coins: 500, 
    bonus: 50,
    price_rub: 399
  },
  {
    id: "ultimate",
    name: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π",
    premium_coins: 1000,
    bonus: 100, 
    price_rub: 799
  }
];

// –ò–≥—Ä–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
class MopsGame {
  static async getUser(userId) {
    let user = await User.findOne({ userId });
    if (!user) {
      user = new User({ 
        userId,
        referralCode: 'REF' + Math.random().toString(36).substr(2, 6).toUpperCase()
      });
      await user.save();
    }
    return user;
  }

  static async tapMops(userId) {
    const user = await this.getUser(userId);
    
    let baseEarn = 1 * user.tapMultiplier;
    let totalMultiplier = user.tapMultiplier;

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç—ã
    user.activeBoosts.forEach(boost => {
      if (boost.effect === 'tap_multiplier' && new Date() < boost.expiresAt) {
        totalMultiplier *= boost.value;
      }
    });

    const finalEarn = baseEarn * totalMultiplier;
    
    user.mopsCoins += finalEarn;
    user.totalTaps += 1;
    await user.save();

    return finalEarn;
  }

  static async generateShopItems(userId) {
    const user = await this.getUser(userId);
    
    if (new Date() < user.shopRefreshTime) {
      return user.shopItems;
    }

    user.shopItems = [];
    const availableCards = CARD_TYPES.filter(card => card.shopChance > 0);
    
    for (let i = 0; i < 3; i++) {
      if (availableCards.length === 0) break;
      
      const totalChance = availableCards.reduce((sum, card) => sum + card.shopChance, 0);
      let random = Math.random() * totalChance;
      
      for (let j = 0; j < availableCards.length; j++) {
        random -= availableCards[j].shopChance;
        if (random <= 0) {
          user.shopItems.push(availableCards[j]);
          availableCards.splice(j, 1);
          break;
        }
      }
    }
    
    user.shopRefreshTime = new Date(Date.now() + 30 * 60 * 1000);
    await user.save();
    
    return user.shopItems;
  }

  static async buyCard(userId, cardId) {
    const user = await this.getUser(userId);
    const card = user.shopItems.find(item => item.id === cardId);
    
    if (!card) return { success: false, error: "–ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    if (user.mopsCoins < card.price) return { success: false, error: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç" };
    
    user.mopsCoins -= card.price;
    user.ownedCards.push({
      id: card.id,
      name: card.name,
      emoji: card.emoji,
      rarity: card.rarity,
      mining: card.mining,
      price: card.price
    });
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞
    user.shopItems = user.shopItems.filter(item => item.id !== cardId);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º mining rate
    await this.updateMiningRate(user);
    await user.save();
    
    return { success: true, card: card.name };
  }

  static async updateMiningRate(user) {
    let miningRate = user.ownedCards.reduce((sum, card) => sum + card.mining, 0);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –±—É—Å—Ç—ã –º–∞–π–Ω–∏–Ω–≥–∞
    user.activeBoosts.forEach(boost => {
      if (boost.effect === 'mining_multiplier' && new Date() < boost.expiresAt) {
        miningRate *= boost.value;
      }
    });
    
    if (user.referralBonusActive) {
      miningRate *= 1.5;
    }
    
    user.miningRate = miningRate;
    await user.save();
  }

  static async processMining(userId) {
    const user = await this.getUser(userId);
    const now = new Date();
    const timePassed = (now - user.lastMiningTime) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    
    if (timePassed > 0) {
      const minedCoins = user.miningRate * timePassed;
      user.mopsCoins += minedCoins;
      user.lastMiningTime = now;
      await user.save();
      
      return minedCoins;
    }
    return 0;
  }

  static async activatePromoCode(userId, code) {
    const user = await this.getUser(userId);
    const codeLower = code.toLowerCase();
    
    if (!PROMO_CODES[codeLower]) {
      return { success: false, message: "–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥" };
    }
    
    if (user.usedPromoCodes.includes(codeLower)) {
      return { success: false, message: "–ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω" };
    }
    
    user.mopsCoins += PROMO_CODES[codeLower].coins;
    user.usedPromoCodes.push(codeLower);
    await user.save();
    
    return { 
      success: true, 
      message: `–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ü–æ–ª—É—á–µ–Ω–æ ${PROMO_CODES[codeLower].coins} üêï` 
    };
  }

  // –î–æ–Ω–∞—Ç —Å–∏—Å—Ç–µ–º–∞
  static async addPremiumCoins(userId, packageId) {
    const user = await this.getUser(userId);
    const package = DONATE_PACKAGES.find(p => p.id === packageId);
    
    if (!package) return { success: false, error: "–ü–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω" };
    
    const totalCoins = package.premium_coins + package.bonus;
    const tokensEarned = totalCoins * user.exchangeRate;
    
    user.premiumCoins += totalCoins;
    user.gameTokens += tokensEarned;
    
    user.transactions.push({
      type: "purchase",
      amount: totalCoins,
      currency: "premium",
      packageId: packageId,
      date: new Date()
    });
    
    await user.save();
    
    return { 
      success: true, 
      coins: totalCoins, 
      tokens: tokensEarned,
      message: `‚úÖ –ö—É–ø–ª–µ–Ω –ø–∞–∫–µ—Ç "${package.name}"!\n–ü–æ–ª—É—á–µ–Ω–æ: ${totalCoins} üíé + ${tokensEarned} ü™ô`
    };
  }

  static async exchangeCurrency(userId, fromCurrency, amount) {
    const user = await this.getUser(userId);
    
    if (fromCurrency === "premium") {
      if (user.premiumCoins < amount) {
        return { success: false, error: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–µ–º–∏—É–º –º–æ–Ω–µ—Ç" };
      }
      
      const tokens = amount * user.exchangeRate;
      user.premiumCoins -= amount;
      user.gameTokens += tokens;
      
      user.transactions.push({
        type: "exchange",
        amount: amount,
        currency: "premium_to_tokens",
        date: new Date()
      });
      
      await user.save();
      return { success: true, tokens: tokens };
      
    } else if (fromCurrency === "tokens") {
      if (user.gameTokens < amount) {
        return { success: false, error: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤" };
      }
      
      const premium = amount / user.exchangeRate;
      user.gameTokens -= amount;
      user.premiumCoins += premium;
      
      user.transactions.push({
        type: "exchange", 
        amount: amount,
        currency: "tokens_to_premium",
        date: new Date()
      });
      
      await user.save();
      return { success: true, premium: premium };
    }
    
    return { success: false, error: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≤–∞–ª—é—Ç–∞" };
  }

  static async buyDonateItem(userId, itemId, currencyType) {
    const user = await this.getUser(userId);
    const item = DONATE_SHOP.find(i => i.id === itemId);
    
    if (!item) return { success: false, error: "–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω" };
    
    const price = currencyType === "premium" ? item.price_premium : item.price_tokens;
    const balance = currencyType === "premium" ? user.premiumCoins : user.gameTokens;
    
    if (balance < price) {
      return { success: false, error: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ${currencyType === "premium" ? "–ø—Ä–µ–º–∏—É–º –º–æ–Ω–µ—Ç" : "–∏–≥—Ä–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤"}` };
    }
    
    // –°–ø–∏—Å—ã–≤–∞–µ–º –≤–∞–ª—é—Ç—É
    if (currencyType === "premium") {
      user.premiumCoins -= price;
    } else {
      user.gameTokens -= price;
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–µ–¥–º–µ—Ç–∞
    if (item.effect === "tap_multiplier" || item.effect === "mining_multiplier") {
      user.activeBoosts.push({
        id: item.id,
        name: item.name,
        effect: item.effect,
        value: item.value,
        expiresAt: new Date(Date.now() + item.duration * 1000)
      });
    } else if (item.effect === "energy") {
      user.mopsCoins += item.value;
    } else if (item.effect === "skin") {
      user.inventory.push({
        id: item.id,
        name: item.name,
        type: item.type,
        effect: item.effect,
        value: item.value,
        purchasedAt: new Date(),
        permanent: true
      });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–∏
    await this.updateMiningRate(user);
    
    user.transactions.push({
      type: "item_purchase",
      itemId: item.id,
      itemName: item.name,
      currency: currencyType,
      price: price,
      date: new Date()
    });
    
    await user.save();
    return { success: true, item: item };
  }

  static async checkBoosts(userId) {
    const user = await this.getUser(userId);
    const now = new Date();
    const expiredBoosts = [];
    
    user.activeBoosts.forEach((boost, index) => {
      if (now >= boost.expiresAt) {
        expiredBoosts.push(index);
      }
    });
    
    // –£–¥–∞–ª—è–µ–º –∏—Å—Ç–µ–∫—à–∏–µ –±—É—Å—Ç—ã
    for (let i = expiredBoosts.length - 1; i >= 0; i--) {
      user.activeBoosts.splice(expiredBoosts[i], 1);
    }
    
    if (expiredBoosts.length > 0) {
      await this.updateMiningRate(user);
      await user.save();
    }
    
    return expiredBoosts.length;
  }

  static async getUserStats(userId) {
    const user = await this.getUser(userId);
    const shopItems = await this.generateShopItems(userId);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    let level = "ü•â –ù–æ–≤–∏—á–æ–∫";
    if (user.mopsCoins >= 10000) level = "üëë –ö–æ—Ä–æ–ª—å –º–æ–ø—Å–æ–≤";
    else if (user.mopsCoins >= 2000) level = "üíé –ú–∞—Å—Ç–µ—Ä";
    else if (user.mopsCoins >= 500) level = "ü•á –ü—Ä–æ—Ñ–∏";
    else if (user.mopsCoins >= 100) level = "ü•à –õ—é–±–∏—Ç–µ–ª—å";
    
    user.level = level;
    await user.save();
    
    return {
      mopsCoins: user.mopsCoins,
      totalTaps: user.totalTaps,
      miningRate: user.miningRate,
      ownedCards: user.ownedCards,
      shopItems: shopItems,
      premiumCoins: user.premiumCoins,
      gameTokens: user.gameTokens,
      activeBoosts: user.activeBoosts,
      inventory: user.inventory,
      level: level,
      referralCode: user.referralCode
    };
  }
}

// Telegram –±–æ—Ç
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  await MopsGame.getUser(userId);
  
  const welcomeMessage = `
üêï *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–æ–ø—Å –¢–∞–ø–æ–ª–∫—É!*

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/tap - –¢–∞–ø–Ω—É—Ç—å –º–æ–ø—Å–∞ üéØ
/shop - –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ üõçÔ∏è  
/inventory - –ú–æ–∏ –º–æ–ø—Å—ã üì¶
/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìä
/donate - –î–æ–Ω–∞—Ç –º–∞–≥–∞–∑–∏–Ω üíé
/promo - –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ üéÅ

*–î–æ–Ω–∞—Ç –≤–∞–ª—é—Ç–∞:*
üíé –ü—Ä–µ–º–∏—É–º –º–æ–Ω–µ—Ç—ã - –ø–æ–∫—É–ø–∞—é—Ç—Å—è –∑–∞ –¥–µ–Ω—å–≥–∏
ü™ô –ò–≥—Ä–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã - –ø–æ–ª—É—á–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (1üíé = 0.1ü™ô)

*–ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /tap —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–µ –º–æ–Ω–µ—Ç—ã!*
  `;
  
  bot.sendMessage(chatId, welcomeMessage, { parse_mode: 'Markdown' });
});

bot.onText(/\/tap/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  const earned = await MopsGame.tapMops(userId);
  const stats = await MopsGame.getUserStats(userId);
  
  const message = `
üéØ *–í—ã —Ç–∞–ø–Ω—É–ª–∏ –º–æ–ø—Å–∞!*

üíµ –ü–æ–ª—É—á–µ–Ω–æ: *${earned.toFixed(2)} –º–æ–Ω–µ—Ç*
üí∞ –ë–∞–ª–∞–Ω—Å: *${Math.floor(stats.mopsCoins)} üêï*
‚ö° –ú–∞–π–Ω–∏–Ω–≥: *${stats.miningRate.toFixed(2)}/—Å–µ–∫*
üèÜ –£—Ä–æ–≤–µ–Ω—å: *${stats.level}*

–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™
  `;
  
  bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

bot.onText(/\/shop/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  const stats = await MopsGame.getUserStats(userId);
  
  let message = `üõçÔ∏è *–ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ –º–æ–ø—Å–æ–≤*\n\n`;
  message += `üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: ${Math.floor(stats.mopsCoins)} üêï\n\n`;
  
  if (stats.shopItems.length === 0) {
    message += "–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç! –ó–∞–π–¥–∏—Ç–µ –ø–æ–∑–∂–µ üîÑ";
  } else {
    stats.shopItems.forEach((card, index) => {
      message += `*${card.emoji} ${card.name}*\n`;
      message += `–†–µ–¥–∫–æ—Å—Ç—å: ${card.rarity}\n`;
      message += `–¶–µ–Ω–∞: ${card.price} üêï\n`;
      message += `–ú–∞–π–Ω–∏–Ω–≥: +${card.mining}/—Å–µ–∫\n`;
      message += `/buy_${card.id}\n\n`;
    });
  }
  
  message += `\nüîÑ –ú–∞–≥–∞–∑–∏–Ω –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç`;
  
  bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

bot.onText(/\/buy_(\d+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const cardId = parseInt(match[1]);
  
  const result = await MopsGame.buyCard(userId, cardId);
  
  if (result.success) {
    bot.sendMessage(chatId, `‚úÖ –í—ã –∫—É–ø–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫—É: ${result.card}`);
  } else {
    bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
  }
});

bot.onText(/\/inventory/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  const stats = await MopsGame.getUserStats(userId);
  
  let message = `üì¶ *–í–∞—à–∏ –º–æ–ø—Å—ã*\n\n`;
  message += `–í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫: ${stats.ownedCards.length}\n\n`;
  
  if (stats.ownedCards.length === 0) {
    message += "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –º–æ–ø—Å–æ–≤ üò¢\n–ó–∞–π–¥–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω /shop";
  } else {
    stats.ownedCards.forEach(card => {
      message += `${card.emoji} *${card.name}* (${card.rarity})\n`;
      message += `–ú–∞–π–Ω–∏–Ω–≥: +${card.mining}/—Å–µ–∫\n\n`;
    });
  }
  
  message += `‚ö° –û–±—â–∏–π –º–∞–π–Ω–∏–Ω–≥: ${stats.miningRate.toFixed(2)}/—Å–µ–∫`;
  
  bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

bot.onText(/\/stats/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  const stats = await MopsGame.getUserStats(userId);
  
  const message = `
üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞*

üí∞ –ú–æ–Ω–µ—Ç—ã: *${Math.floor(stats.mopsCoins)} üêï*
üéØ –í—Å–µ–≥–æ —Ç–∞–ø–æ–≤: *${stats.totalTaps}*
‚ö° –ú–∞–π–Ω–∏–Ω–≥: *${stats.miningRate.toFixed(2)}/—Å–µ–∫*
üèÜ –£—Ä–æ–≤–µ–Ω—å: *${stats.level}*

üíé –ü—Ä–µ–º–∏—É–º: *${stats.premiumCoins}*
ü™ô –¢–æ–∫–µ–Ω—ã: *${stats.gameTokens.toFixed(1)}*
üì¶ –ú–æ–ø—Å–æ–≤: *${stats.ownedCards.length}*

üéÅ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: *${stats.referralCode}*
  `;
  
  bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

bot.onText(/\/donate/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  const stats = await MopsGame.getUserStats(userId);
  
  let message = `üíé *–î–æ–Ω–∞—Ç –º–∞–≥–∞–∑–∏–Ω*\n\n`;
  message += `üíé –ü—Ä–µ–º–∏—É–º: ${stats.premiumCoins}\n`;
  message += `ü™ô –¢–æ–∫–µ–Ω—ã: ${stats.gameTokens.toFixed(1)}\n`;
  message += `üí± –ö—É—Ä—Å: 1üíé = 0.1ü™ô\n\n`;
  
  message += `*üõçÔ∏è –î–æ–Ω–∞—Ç –ø—Ä–µ–¥–º–µ—Ç—ã:*\n`;
  DONATE_SHOP.forEach(item => {
    message += `*${item.name}*\n`;
    message += `${item.description}\n`;
    message += `üíé ${item.price_premium} | ü™ô ${item.price_tokens}\n`;
    message += `/buy_donate_${item.id}\n\n`;
  });
  
  message += `*üì¶ –ü–∞–∫–µ—Ç—ã –ø—Ä–µ–º–∏—É–º –º–æ–Ω–µ—Ç:*\n`;
  DONATE_PACKAGES.forEach(pkg => {
    message += `*${pkg.name}* - ${pkg.price_rub}‚ÇΩ\n`;
    message += `${pkg.premium_coins}üíé + ${pkg.bonus}üíé –±–æ–Ω—É—Å\n`;
    message += `/buy_package_${pkg.id}\n\n`;
  });
  
  message += `üí± *–û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã:*\n`;
  message += `/exchange_10_premium - –æ–±–º–µ–Ω—è—Ç—å 10üíé –Ω–∞ 1ü™ô\n`;
  message += `/exchange_50_tokens - –æ–±–º–µ–Ω—è—Ç—å 50ü™ô –Ω–∞ 5üíé\n`;
  
  bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

bot.onText(/\/buy_donate_(.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const itemId = match[1];
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞–ª—é—Ç—É –ø–æ –±–∞–ª–∞–Ω—Å—É
  const stats = await MopsGame.getUserStats(userId);
  const item = DONATE_SHOP.find(i => i.id === itemId);
  
  if (!item) {
    bot.sendMessage(chatId, "‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
    return;
  }
  
  let currencyType = "premium";
  if (stats.gameTokens >= item.price_tokens && stats.premiumCoins < item.price_premium) {
    currencyType = "tokens";
  }
  
  const result = await MopsGame.buyDonateItem(userId, itemId, currencyType);
  
  if (result.success) {
    bot.sendMessage(chatId, `‚úÖ –ö—É–ø–ª–µ–Ω–æ: ${result.item.name}\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –≤–∞–ª—é—Ç–∞: ${currencyType === "premium" ? "üíé" : "ü™ô"}`);
  } else {
    bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
  }
});

bot.onText(/\/buy_package_(.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const packageId = match[1];
  
  // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
  // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∏—Å–ª—è–µ–º –º–æ–Ω–µ—Ç—ã
  const result = await MopsGame.addPremiumCoins(userId, packageId);
  
  if (result.success) {
    bot.sendMessage(chatId, result.message + `\n\nüí∏ *–í —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ*`);
  } else {
    bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
  }
});

bot.onText(/\/exchange_(\d+)_(premium|tokens)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const amount = parseInt(match[1]);
  const currency = match[2];
  
  const result = await MopsGame.exchangeCurrency(userId, currency, amount);
  
  if (result.success) {
    if (currency === "premium") {
      bot.sendMessage(chatId, `‚úÖ –û–±–º–µ–Ω —É—Å–ø–µ—à–µ–Ω!\n–û—Ç–¥–∞–Ω–æ: ${amount}üíé\n–ü–æ–ª—É—á–µ–Ω–æ: ${result.tokens.toFixed(1)}ü™ô`);
    } else {
      bot.sendMessage(chatId, `‚úÖ –û–±–º–µ–Ω —É—Å–ø–µ—à–µ–Ω!\n–û—Ç–¥–∞–Ω–æ: ${amount}ü™ô\n–ü–æ–ª—É—á–µ–Ω–æ: ${result.premium.toFixed(1)}üíé`);
    }
  } else {
    bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
  }
});

bot.onText(/\/promo/, async (msg) => {
  const chatId = msg.chat.id;
  
  const message = `
üéÅ *–ü—Ä–æ–º–æ–∫–æ–¥—ã*

–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã:
‚Ä¢ *mops* - 5000 üêï
‚Ä¢ *mandarin* - 5000 üêï  
‚Ä¢ *kolbasa* - 5000 üêï

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /promo_–ö–û–î
–ü—Ä–∏–º–µ—Ä: /promo_mops
  `;
  
  bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
});

bot.onText(/\/promo_(.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const code = match[1];
  
  const result = await MopsGame.activatePromoCode(userId, code);
  
  bot.sendMessage(chatId, result.message);
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞–π–Ω–∏–Ω–≥ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
setInterval(async () => {
  try {
    const users = await User.find({});
    
    for (const user of users) {
      const mined = await MopsGame.processMining(user.userId);
      const expired = await MopsGame.checkBoosts(user.userId);
      
      if (mined > 0.1) { // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–º–∞–π–Ω–∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
        const message = `‚õèÔ∏è –ê–≤—Ç–æ–º–∞–π–Ω–∏–Ω–≥: +${mined.toFixed(2)} üêï`;
        bot.sendMessage(user.userId, message).catch(err => {
          // –ò–≥—Ä–æ–∫ –º–æ–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        });
      }
    }
  } catch (error) {
    console.log('Mining error:', error);
  }
}, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

// –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
app.post('/webhook/payment', async (req, res) => {
  try {
    const { userId, amount, packageId, paymentId } = req.body;
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –ø–ª–∞—Ç–µ–∂–∞
    const result = await MopsGame.addPremiumCoins(userId, packageId);
    
    if (result.success) {
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await bot.sendMessage(userId, `‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!\n${result.message}`);
      res.json({ success: true });
    } else {
      res.status(400).json({ error: result.error });
    }
  } catch (error) {
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.get('/user/:userId', async (req, res) => {
  try {
    const stats = await MopsGame.getUserStats(parseInt(req.params.userId));
    res.json(stats);
  } catch (error) {
    res.status(500).json({ error: 'User not found' });
  }
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(PORT, () => {
  console.log(`üöÄ Server running on port ${PORT}`);
  console.log(`ü§ñ Telegram bot started`);
});

console.log(`
üéÆ –ú–æ–ø—Å –¢–∞–ø–æ–ª–∫–∞ - –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞!

üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
/tap - –¢–∞–ø–Ω—É—Ç—å –º–æ–ø—Å–∞  
/shop - –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–µ–∫
/inventory - –ú–æ–∏ –º–æ–ø—Å—ã
/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/donate - –î–æ–Ω–∞—Ç –º–∞–≥–∞–∑–∏–Ω
/promo - –ü—Ä–æ–º–æ–∫–æ–¥—ã

üíé –î–æ–Ω–∞—Ç —Å–∏—Å—Ç–µ–º–∞:
- 2 –≤–∞–ª—é—Ç—ã: –ø—Ä–µ–º–∏—É–º –º–æ–Ω–µ—Ç—ã –∏ –∏–≥—Ä–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
- –ö—É—Ä—Å –æ–±–º–µ–Ω–∞: 1üíé = 0.1ü™ô
- –ú–∞–≥–∞–∑–∏–Ω —Å –±—É—Å—Ç–∞–º–∏ –∏ —Å–∫–∏–Ω–∞–º–∏
- –ü–∞–∫–µ—Ç—ã –ø–æ–∫—É–ø–∫–∏ –æ—Ç 99‚ÇΩ

‚ö° –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞–π–Ω–∏–Ω–≥
- –°–∏—Å—Ç–µ–º–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –º–æ–ø—Å–æ–≤
- –ü—Ä–æ–º–æ–∫–æ–¥—ã
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
`);
